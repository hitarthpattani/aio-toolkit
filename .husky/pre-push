#!/bin/sh
# Husky pre-push hook - ULTRA STRICT MODE
set -e  # Exit immediately on any error

echo "ğŸš€ ULTRA-STRICT PRE-PUSH VALIDATION STARTING..."
echo "â›” Any failure will BLOCK the push completely!"
echo "ğŸ¯ This is your final quality gate before code goes to remote!"
echo ""

# Step 1: Format validation (strict - no auto-fix)
echo "ğŸ’… Step 1/6: Strict formatting validation..."
if ! npm run format:check; then
    echo "âŒ PUSH BLOCKED: Code formatting issues detected!"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting issues."
    exit 1
fi
echo "âœ… All files properly formatted"
echo ""

# Step 2: Linting validation (strict - no auto-fix)
echo "ğŸ” Step 2/6: Strict linting validation..."
if ! npm run lint; then
    echo "âŒ PUSH BLOCKED: Linting errors detected!"
    echo "ğŸ’¡ Run 'npm run lint:fix' to fix linting issues."
    exit 1
fi
echo "âœ… All linting rules satisfied"
echo ""

# Step 3: TypeScript compilation check
echo "ğŸ”§ Step 3/6: TypeScript compilation validation..."
if ! npm run type-check; then
    echo "âŒ PUSH BLOCKED: TypeScript compilation failed!"
    echo "ğŸ’¡ Fix all TypeScript errors before pushing."
    exit 1
fi
echo "âœ… TypeScript compilation successful"
echo ""

# Step 4: Full test suite WITH coverage (most critical)
echo "ğŸ§ª Step 4/6: Full test suite with coverage requirements..."
echo "ğŸ“Š Testing with strict coverage thresholds..."
if ! npm run test:ci; then
    echo "âŒ PUSH BLOCKED: Tests failed or coverage below threshold!"
    echo "ğŸ’¡ Fix failing tests and ensure 100% coverage before pushing."
    exit 1
fi
echo "âœ… All tests passed with required coverage"
echo ""

# Step 5: Build validation
echo "ğŸ—ï¸ Step 5/6: Production build validation..."
if ! npm run build; then
    echo "âŒ PUSH BLOCKED: Production build failed!"
    echo "ğŸ’¡ Fix build errors before pushing."
    exit 1
fi
echo "âœ… Production build successful"
echo ""

# Step 6: Final comprehensive check
echo "ğŸ¯ Step 6/6: Final comprehensive validation..."
echo "ğŸ”„ Running complete validation pipeline..."
if ! npm run validate:push; then
    echo "âŒ PUSH BLOCKED: Final validation failed!"
    echo "ğŸ’¡ Something changed during the process. Re-run all checks."
    exit 1
fi
echo "âœ… Final validation completed successfully"
echo ""

echo "ğŸ‰ğŸš€ ULTRA-STRICT PRE-PUSH VALIDATION COMPLETED! ğŸš€ğŸ‰"
echo "âœ… Your code meets ALL quality standards!"
echo "âœ… Safe to push to remote repository!"
echo "ğŸ“¦ Build artifacts ready for distribution!"

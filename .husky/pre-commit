#!/bin/sh
# Husky pre-commit hook - STRICT MODE
set -e  # Exit immediately on any error

echo "ğŸ›¡ï¸ STRICT PRE-COMMIT VALIDATION STARTING..."
echo "âš ï¸  Any failure will STOP the commit process!"
echo ""

# Step 1: Compile check first (fail fast)
echo "ğŸ”¨ Step 1/4: Compile validation..."
if ! npm run type-check; then
    echo "âŒ COMMIT BLOCKED: TypeScript compilation failed!"
    echo "ğŸ’¡ Fix compilation errors before committing."
    exit 1
fi
echo "âœ… Compilation successful"
echo ""

# Step 2: Auto-fix linting and formatting on staged files
echo "ğŸ› ï¸ Step 2/4: Auto-fixing linting and formatting..."
if ! npx lint-staged; then
    echo "âŒ COMMIT BLOCKED: Linting/formatting failed!"
    echo "ğŸ’¡ Check the errors above and fix them manually."
    exit 1
fi
echo "âœ… Linting and formatting completed"
echo ""

# Step 3: Run tests (without coverage) - fast validation
echo "ğŸ§ª Step 3/4: Running tests (no coverage)..."
if ! npm run test:fast; then
    echo "âŒ COMMIT BLOCKED: Tests failed!"
    echo "ğŸ’¡ Fix failing tests before committing."
    exit 1
fi
echo "âœ… All tests passed"
echo ""

# Step 4: Final validation
echo "ğŸ” Step 4/4: Final validation..."
if ! npm run format:check; then
    echo "âŒ COMMIT BLOCKED: Code formatting issues detected!"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting."
    exit 1
fi
echo "âœ… Format validation passed"
echo ""

echo "ğŸ‰ PRE-COMMIT VALIDATION COMPLETED SUCCESSFULLY!"
echo "âœ… Your code is ready to commit!"